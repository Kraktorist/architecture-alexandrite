## Выбор и настройка мониторинга в системе

### Мотивация

1. Поможет найти корень текущих проблем с заказами.

1. Алертинг. Позволит быстрее реагировать на возникающие проблемы, в том числе предугадывать их.

1. Сравнение производительности. Даст информацию о том, насколько изменяется производительность новых версий приложения, как влияют те или иные изменения на производительность

1. Позволит эффективно планировать и расходовать облачные ресурсы.

### Выбор подхода к мониторингу

Для веб-сервисов лучше выбрать методику `RED`, разработанную для мониторинга характеристик потока сообщений и направленную на анализ RPS, latency и delays. Также может быть применена методика `Four Golden Signals`, расширяющая `RED` добавлением показателей saturation.

Для инфраструктурных и смежных с ней систем лучше использовать `USE`, предоставляющий больше информации об узких местах в системе.

Подходы

| Сервис         | Подход   | боснование                                                                                                                                                                                                                 |
| -------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Онлайн-магазин | RED      | Типовой подход для ониторинга веб-сервисов, отличающийся направленностью на нализ потока обытий                                                                                                                                                                                |
| CRM            | RED      | Типовой подход для ониторинга еб-сервисов                                                                                                                                                                                 |
| MES            | USE, RED | Для web и API части одойдет подход RED, ориентированный на подсчет апросов<br>Для обработчика, рассчитывающего модели и тилизирующего значительные ресурсы подойдет метод USE, тслеживающий глубину использования ресурсов и узкие еста |
| Инфраструктура | USE      | Метод, специально ориентированный на мониторинг инфраструктуры                                                                                                                                                                 |

### Метрики

#### Инфраструктура
Инфраструктура облачная, предоставляет собственные етрики, которые могут быть экспортированы в собственную истему мониторинга через [API](https://yandex.cloud/ru/ocs/monitoring/api-ref/MetricsMeta/listMetrics).

Метрики изнутри операционной системы могут быть получены  использованием [Unified Agent](https://yandex.cloud/ru/ocs/monitoring/metrics-ref/unifiedagent-ref).
Ключевыми метриками здесь будут:

- CPU
  - очередь задач (load average)
  - ошибки ECC
  - процент использования
  
  метрики собираются для каждого ядра на каждой машине

- RAM
  - доступная память
  - использующаяся память
  - количество page faults, page scan
  - OOM kills count
  использующаяся память собирается по типу (ядро, буферы, кэш, пользовательские процессы итд)

- Диски и ФС
  - ошибки дисков
  - длина очереди записи на диск
  - время записи на диск
  - доступный объем на фс
  - использующийся объем на фс
  - количество операций чтения, записи
  - cache hit ratio

- Сеть
  - объем данных при приеме и передаче для каждого интерфейса в пакетах и гигабайтах
  - количество пакетов в очереди
  - ошибки 
  - количество соединений
  
#### rabbitmq
- длина очереди
- скорость поступления и обработки сообщений
- скорость обработки сообщений по консьюмерам
- возраст сообщений
- количество сообщений в DLQ
- количество сообщений in flight
#### postgresql
- размер БД
- количество подключений
- использование памяти
- долгие запросы
- количество блокировок
- cache hit ratio
- использование индексов и сканирования таблиц
- состояние WAL файлов
- replication lag (когда будет построен кластер)
#### api, web

- количество запросов 
- время выполнения запросов
- количество ошибок 5хх

#### business metrics
- DAU, MAU
- общее количество заказов
- количество активных заказов по этапам производства
- время исполнения на каждом этапе
  
NB: Такие метрики можно построить как производные от ехнических метрик. Например, 
- каждый запрос `POST /api/create` в онлайн-магазине ожно считать как создание заказа;
- результат определенного запроса к БД CRM можно нтерпретировать как количество заказов;
- каждое вычитанное сообщение из очереди RabbitMQ можно нтерпретировать как переход заказа на новый этап;


### План действий

1. Сбор требований к мониторингу
    - функционал и покрытие
    - интеграции (с экспортерами, системами для алертинга итп)
    - требующиеся ресурсы
    - стоимость проекта
    - порядок эксплуатации
1. Анализ имеющихся решений:
    - выбор между prometheus, victoria metrics или managed prometheus
    - необходимые компоненты (экспортеры, pushgateways, alertmanagers, alerting systems)
1. Архитектура решения
    - компоновка решения
    - подготовка проекта внедрения
1. Подготовка инфраструктуры для развертывания
    - виртуальные машины
    - базы данных
    - хранилище для метрик
1. Развертывание системы мониторинга
    - развертывание core сервисов (tsdb и prometheus)
    - alertmanager
    - grafana
    - экспортеры
1. Сбор метрик с сервисов
    - включение встроенных экспортеров на сервисах
    - доработка приложений для экспорта метрик в формате prometheus (sidecars, экспортеры)
1. Построение дашбордов
1. Анализ собранных данных 
    - определение характера нагрузки на подсистемы
    - определение baseline величин для ключевых метрик
    - создание правил для алертинга
    - классификация правил алертинга по приоритету и ответственным

